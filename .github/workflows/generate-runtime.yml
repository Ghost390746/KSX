name: Generate Runtime

on:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate Runtime JS
        run: |
          mkdir -p hsx/Flows/runtimes
          for DIR in hsx/Flows/projects/*; do
            [ -d "$DIR" ] || continue
            LANG_NAME=$(basename "$DIR")
            LANG_FILE="$DIR/language.txt"
            RUNTIME_FILE="hsx/Flows/runtimes/${LANG_NAME}-runtime.js"

            echo "// Auto-generated runtime for $LANG_NAME" > "$RUNTIME_FILE"

            # Generate JS functions for each command in language.txt
            if [ -f "$LANG_FILE" ]; then
              while IFS=: read -r command desc; do
                if [ -n "$command" ]; then
                  SAFE_COMMAND=${command// /_}
                  echo "function $SAFE_COMMAND() { console.log('Executing $command'); }" >> "$RUNTIME_FILE"
                fi
              done < "$LANG_FILE"
            fi
          done
